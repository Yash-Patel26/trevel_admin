name: Deploy to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate
      
      - name: Build TypeScript
        working-directory: ./backend
        run: npm run build
      
      - name: Run tests
        working-directory: ./backend
        run: npm test || echo "No tests configured yet"
      
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
          
          # Create deployment package
          cd backend
          tar -czf ../deploy.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='uploads' \
            --exclude='*.log' \
            .
          
          # Upload to EC2
          scp -i ~/.ssh/deploy_key.pem ../deploy.tar.gz $EC2_USER@$EC2_HOST:/tmp/
          
          # Execute deployment script on EC2
          ssh -i ~/.ssh/deploy_key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            
            # Extract new code
            mkdir -p ~/backend_new
            tar -xzf /tmp/deploy.tar.gz -C ~/backend_new
            rm /tmp/deploy.tar.gz
            
            # Copy environment file
            if [ -f ~/backend/.env ]; then
              cp ~/backend/.env ~/backend_new/.env
            fi
            
            # Run deployment script
            cd ~/backend_new
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh
            
            # Cleanup
            if [ -d ~/backend_old ]; then
              rm -rf ~/backend_old
            fi
            if [ -d ~/backend ]; then
              mv ~/backend ~/backend_old
            fi
            mv ~/backend_new ~/backend
            
            echo "✅ Deployment completed successfully!"
          ENDSSH
      
      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          
          # Wait for service to stabilize
          sleep 10
          
          # Run health check
          ssh -i ~/.ssh/deploy_key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            cd ~/backend
            ./scripts/health-check.sh
          ENDSSH
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed! Check logs above for details."
          echo "The previous version should still be running."
