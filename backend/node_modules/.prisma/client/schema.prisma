generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  users       User[]
  permissions RolePermission[]
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  roles       RolePermission[]
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model User {
  id              Int            @id @default(autoincrement())
  email           String         @unique
  fullName        String?
  passwordHash    String
  isActive        Boolean        @default(true)
  roleId          Int
  role            Role           @relation(fields: [roleId], references: [id])
  auditLogs       AuditLog[]
  vehicles        Vehicle[]      @relation("VehicleCreator")
  drivers         Driver[]       @relation("DriverCreator")
  ticketAssignees Ticket[]       @relation("TicketAssignee")
  refreshTokens   RefreshToken[]
}

model RefreshToken {
  id        Int       @id @default(autoincrement())
  token     String    @unique
  userId    Int
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@index([userId])
  @@index([token])
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  actorId    Int?
  actor      User?    @relation(fields: [actorId], references: [id])
  action     String
  entityType String
  entityId   String?
  before     Json?
  after      Json?
  createdAt  DateTime @default(now())

  @@index([actorId, createdAt]) // User's actions chronologically
  @@index([entityType, entityId]) // Entity history
  @@index([createdAt]) // Recent activity
}

model Vehicle {
  id                    String              @id @default(uuid())
  numberPlate           String              @unique @map("number_plate")
  make                  String?
  model                 String?
  insurancePolicyNumber String?
  insuranceExpiry       DateTime?
  liveLocationKey       String?
  dashcamKey            String?
  status                String              @default("pending")
  createdBy             Int?
  creator               User?               @relation("VehicleCreator", fields: [createdBy], references: [id])
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  reviews               VehicleReview[]
  logs                  VehicleLog[]
  assignments           VehicleAssignment[]
  rideSummaries         RideSummary[]

  // Mobile app specific relations
  miniTrips        MiniTripBooking[]
  hourlyRentals    HourlyRentalBooking[]
  toAirportTrips   ToAirportTransferBooking[]
  fromAirportTrips FromAirportTransferBooking[]
  bookings         Booking[]

  @@index([status]) // Filter by status
  @@index([status, createdAt]) // Status with recency
}

model VehicleReview {
  id         Int      @id @default(autoincrement())
  vehicleId  String
  reviewerId Int?
  status     String   @default("pending")
  comments   String?
  createdAt  DateTime @default(now())
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id])
}

model VehicleLog {
  id        Int      @id @default(autoincrement())
  vehicleId String
  actorId   Int?
  action    String
  payload   Json?
  createdAt DateTime @default(now())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id])
}

model VehicleAssignment {
  id           Int       @id @default(autoincrement())
  vehicleId    String
  driverId     String
  assignedBy   Int?
  assignedAt   DateTime  @default(now())
  unassignedAt DateTime?
  vehicle      Vehicle   @relation(fields: [vehicleId], references: [id])
  driver       Driver    @relation(fields: [driverId], references: [id])
}

model Driver {
  id                  String                     @id @default(uuid())
  name                String                     @map("full_name") // Map to mobile definition
  mobile              String                     @unique @map("phone") // Map to mobile definition
  email               String?
  status              String                     @default("pending")
  licenseNumber       String?                    @unique @map("license_number") // Added for mobile compatibility
  rating              Float?                     @default(0) // Driver rating (0-5)
  totalTrips          Int?                       @default(0) @map("total_trips") // Total completed trips
  profileImageUrl     String?                    @map("profile_image_url") // Driver profile photo URL
  onboardingData      Json?
  contactPreferences  Json?
  createdBy           Int?
  creator             User?                      @relation("DriverCreator", fields: [createdBy], references: [id])
  createdAt           DateTime                   @default(now()) @map("created_at")
  updatedAt           DateTime                   @updatedAt @map("updated_at")
  documents           DriverDocument[]
  backgroundChecks    DriverBackgroundCheck[]
  trainingAssignments DriverTrainingAssignment[]
  logs                DriverLog[]
  assignments         VehicleAssignment[]
  rideSummaries       RideSummary[]
  bookings            Booking[]

  @@index([status]) // Filter by status
  @@index([status, rating]) // Available drivers by rating
}

model DriverDocument {
  id         Int       @id @default(autoincrement())
  driverId   String
  type       String
  url        String
  status     String    @default("uploaded")
  verifiedBy Int?
  verifiedAt DateTime?
  driver     Driver    @relation(fields: [driverId], references: [id])
}

model DriverBackgroundCheck {
  id         Int       @id @default(autoincrement())
  driverId   String
  status     String    @default("pending")
  notes      String?
  verifiedBy Int?
  verifiedAt DateTime?
  driver     Driver    @relation(fields: [driverId], references: [id])
}

model DriverTrainingAssignment {
  id          Int       @id @default(autoincrement())
  driverId    String
  module      String
  status      String    @default("assigned")
  assignedBy  Int?
  completedAt DateTime?
  driver      Driver    @relation(fields: [driverId], references: [id])
}

model DriverLog {
  id        Int      @id @default(autoincrement())
  driverId  String
  actorId   Int?
  action    String
  payload   Json?
  createdAt DateTime @default(now())
  driver    Driver   @relation(fields: [driverId], references: [id])
}

model Ticket {
  id            Int            @id @default(autoincrement())
  vehicleNumber String?
  driverName    String?
  driverMobile  String?
  category      String?
  priority      String         @default("medium")
  status        String         @default("open")
  description   String?
  assignedTo    Int?
  assignee      User?          @relation("TicketAssignee", fields: [assignedTo], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  updates       TicketUpdate[]

  @@index([status, priority]) // Filter and sort tickets
  @@index([assignedTo, status]) // Assignee's tickets
  @@index([createdAt]) // Recent tickets
}

model TicketUpdate {
  id        Int      @id @default(autoincrement())
  ticketId  Int
  actorId   Int?
  status    String?
  notes     String?
  createdAt DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
}

model Notification {
  id        Int      @id @default(autoincrement())
  actorId   Int?
  targetId  String?
  type      String
  channel   String   @default("in-app")
  payload   Json?
  status    String   @default("queued")
  createdAt DateTime @default(now())
}

model RideSummary {
  id         Int       @id @default(autoincrement())
  vehicleId  String
  driverId   String?
  startedAt  DateTime
  endedAt    DateTime?
  distanceKm Float?
  status     String    @default("completed")
  vehicle    Vehicle   @relation(fields: [vehicleId], references: [id])
  driver     Driver?   @relation(fields: [driverId], references: [id])
}

model Customer {
  id              String  @id @default(uuid())
  name            String?
  mobile          String  @unique
  email           String? @unique
  profileImageUrl String? @map("profile_image_url")
  status          String  @default("active")

  bookings Booking[]

  // Mobile app specific relations
  miniTrips        MiniTripBooking[]
  hourlyRentals    HourlyRentalBooking[]
  toAirportTrips   ToAirportTransferBooking[]
  fromAirportTrips FromAirportTransferBooking[]
  savedLocations   SavedLocation[]
}

model Booking {
  id                   Int       @id @default(autoincrement())
  customerId           String
  customer             Customer  @relation(fields: [customerId], references: [id])
  pickupLocation       String
  pickupLatitude       Float?
  pickupLongitude      Float?
  destinationLocation  String
  destinationLatitude  Float?
  destinationLongitude Float?
  pickupTime           DateTime
  destinationTime      DateTime?
  vehicleModel         String?
  status               String    @default("upcoming") // upcoming, today, completed, canceled
  vehicleId            String?
  vehicle              Vehicle?  @relation(fields: [vehicleId], references: [id])
  driverId             String?
  driver               Driver?   @relation(fields: [driverId], references: [id])
  otpCode              String?   @db.Char(4)
  otpExpiresAt         DateTime?
  createdAt            DateTime  @default(now())

  @@index([customerId])
  @@index([status])
  @@index([pickupTime])
  @@index([customerId, status]) // Customer's bookings by status
  @@index([status, pickupTime]) // All bookings by status and time
  @@index([customerId, pickupTime]) // Customer's bookings chronologically
}

// Mobile App Booking Models

model MiniTripBooking {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")
  user                Customer @relation(fields: [userId], references: [id], onDelete: Cascade)
  pickupLocation      String   @map("pickup_location")
  pickupCity          String?  @map("pickup_city")
  pickupState         String?  @map("pickup_state")
  dropoffLocation     String   @map("dropoff_location")
  dropoffCity         String?  @map("dropoff_city")
  dropoffState        String?  @map("dropoff_state")
  pickupDate          DateTime @map("pickup_date") @db.Date
  pickupTime          DateTime @map("pickup_time") @db.Time
  vehicleId           String?  @map("vehicle_id")
  vehicle             Vehicle? @relation(fields: [vehicleId], references: [id])
  vehicleSelected     String   @map("vehicle_selected")
  vehicleImageUrl     String?  @map("vehicle_image_url")
  passengerName       String   @map("passenger_name")
  passengerEmail      String?  @map("passenger_email")
  passengerPhone      String   @map("passenger_phone")
  estimatedDistanceKm Float    @map("estimated_distance_km")
  estimatedTimeMin    DateTime @default(dbgenerated("'00:00:00'::time")) @map("estimated_time_min") @db.Time
  basePrice           Float    @map("base_price")
  gstAmount           Float?   @default(0) @map("gst_amount")
  finalPrice          Float    @map("final_price")
  currency            String   @default("INR")
  status              String   @default("pending")
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([userId])
  @@index([status])
  @@index([pickupDate])
  @@index([userId, status, pickupDate]) // User's bookings filtered and sorted
  @@index([status, pickupDate]) // All bookings by status and date
  @@index([createdAt]) // Recent bookings
  @@map("mini_trip_bookings")
}

model HourlyRentalBooking {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  user              Customer @relation(fields: [userId], references: [id], onDelete: Cascade)
  pickupLocation    String   @map("pickup_location")
  pickupCity        String?  @map("pickup_city")
  pickupState       String?  @map("pickup_state")
  pickupDate        DateTime @map("pickup_date") @db.Date
  pickupTime        DateTime @map("pickup_time") @db.Time
  vehicleId         String?  @map("vehicle_id")
  vehicle           Vehicle? @relation(fields: [vehicleId], references: [id])
  vehicleSelected   String   @map("vehicle_selected")
  vehicleImageUrl   String?  @map("vehicle_image_url")
  passengerName     String   @map("passenger_name")
  passengerEmail    String?  @map("passenger_email")
  passengerPhone    String   @map("passenger_phone")
  rentalHours       Float    @map("rental_hours")
  coveredDistanceKm Float    @map("covered_distance_km")
  basePrice         Float    @map("base_price")
  gstAmount         Float?   @default(0) @map("gst_amount")
  finalPrice        Float    @map("final_price")
  currency          String   @default("INR")
  notes             String?
  status            String   @default("pending")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([userId])
  @@index([status])
  @@index([pickupDate])
  @@map("hourly_rental_bookings")
}

model ToAirportTransferBooking {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")
  user                Customer @relation(fields: [userId], references: [id], onDelete: Cascade)
  pickupLocation      String   @map("pickup_location")
  pickupDate          DateTime @map("pickup_date") @db.Date
  pickupTime          DateTime @map("pickup_time") @db.Time
  destinationAirport  String   @map("destination_airport")
  vehicleId           String?  @map("vehicle_id")
  vehicle             Vehicle? @relation(fields: [vehicleId], references: [id])
  vehicleSelected     String?  @map("vehicle_selected")
  vehicleImageUrl     String?  @map("vehicle_image_url")
  passengerName       String   @map("passenger_name")
  passengerEmail      String?  @map("passenger_email")
  passengerPhone      String?  @map("passenger_phone")
  estimatedDistanceKm Float?   @map("estimated_distance_km")
  estimatedTimeMin    DateTime @default(dbgenerated("'00:00:00'::time")) @map("estimated_time_min") @db.Time
  basePrice           Float    @map("base_price")
  gstAmount           Float?   @default(0) @map("gst_amount")
  finalPrice          Float    @map("final_price")
  currency            String   @default("INR")
  status              String   @default("pending")
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([userId])
  @@index([status])
  @@index([pickupDate])
  @@map("to_airport_transfer_bookings")
}

model FromAirportTransferBooking {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")
  user                Customer @relation(fields: [userId], references: [id], onDelete: Cascade)
  pickupLocation      String   @map("pickup_location")
  pickupDate          DateTime @map("pickup_date") @db.Date
  pickupTime          DateTime @map("pickup_time") @db.Time
  destinationAirport  String   @map("destination_airport")
  vehicleId           String?  @map("vehicle_id")
  vehicle             Vehicle? @relation(fields: [vehicleId], references: [id])
  vehicleSelected     String?  @map("vehicle_selected")
  vehicleImageUrl     String?  @map("vehicle_image_url")
  passengerName       String   @map("passenger_name")
  passengerEmail      String?  @map("passenger_email")
  passengerPhone      String?  @map("passenger_phone")
  estimatedDistanceKm Float?   @map("estimated_distance_km")
  estimatedTimeMin    DateTime @default(dbgenerated("'00:00:00'::time")) @map("estimated_time_min") @db.Time
  basePrice           Float    @map("base_price")
  gstAmount           Float?   @default(0) @map("gst_amount")
  finalPrice          Float    @map("final_price")
  currency            String   @default("INR")
  status              String   @default("pending")
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@index([userId])
  @@index([status])
  @@index([pickupDate])
  @@map("from_airport_transfer_bookings")
}

model Airport {
  id           String   @id @default(uuid())
  airportCode  String   @unique @map("airport_code")
  airportName  String   @map("airport_name")
  city         String
  country      String   @default("India")
  latitude     Float
  longitude    Float
  terminal     String?
  fullLocation String?  @map("full_location")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("airports")
}

model SavedLocation {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  customer   Customer @relation(fields: [userId], references: [id])
  name       String
  address    String
  latitude   Float?
  longitude  Float?
  city       String?
  state      String?
  country    String?  @default("India")
  postalCode String?  @map("postal_code")
  isDefault  Boolean  @default(false) @map("is_default")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("saved_locations")
}

model PricingConfig {
  id          String   @id @default(uuid())
  serviceType String   @unique @map("service_type") // 'mini-travel', 'hourly-rental', 'airport-drop', 'airport-pickup'
  config      Json // Stores the pricing structure (tiers, rates, etc.)
  isActive    Boolean  @default(true) @map("is_active")
  updatedAt   DateTime @updatedAt @map("updated_at")
  updatedBy   Int?     @map("updated_by") // Admin User ID

  @@map("pricing_configs")
}

model Make {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  type        String   @default("sedan")
  capacity    Int      @default(4)
  luggage     Int      @default(0)
  basePrice   Decimal  @default(0) @map("base_price") @db.Decimal(10, 2)
  imageUrl    String?  @map("image_url")
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  // Tracking
  model         String?
  numberPlate   String?   @map("number_plate")
  color         String?
  driverId      String?   @map("driver_id") @db.Uuid
  currentLat    Decimal?  @map("current_latitude") @db.Decimal(10, 8)
  currentLng    Decimal?  @map("current_longitude") @db.Decimal(11, 8)
  lastTrackedAt DateTime? @map("last_tracked_at")
  deviceImei    String?   @map("device_imei")
  deviceName    String?   @map("device_name")

  // Pricing
  seats        Int?     @default(4)
  serviceTypes String[] @map("service_types")
  oemRangeKms  Decimal? @map("oem_range_kms") @db.Decimal(10, 2)
  priceAmount  Decimal? @map("price_amount") @db.Decimal(10, 2)
  priceUnit    String?  @default("per ride") @map("price_unit")
  etaText      String?  @map("eta_text")
  distanceText String?  @map("distance_text")
  seatLabel    String?  @map("seat_label")
  category     String?

  @@index([isActive])
  @@index([type])
  @@index([driverId])
  @@index([numberPlate])
  @@index([deviceImei])
  @@map("makes")
}
